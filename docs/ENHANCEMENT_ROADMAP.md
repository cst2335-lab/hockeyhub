# GoGoHockey 功能增强与优化路线图

**来源**：审查反馈与产品规划整理  
**用途**：供开发排期、AI 协作及评审参考  
**更新**：2026-02

---

## 一、核心业务功能增强

### 1.1 比赛匹配与推荐

| 属性 | 内容 |
|------|------|
| **模块** | 比赛匹配与推荐 |
| **类型** | 功能增强 |
| **优先级** | 高 |

**现状问题**：当前仅有「感兴趣」按钮，缺乏智能匹配机制。

**建议方案**：
- **智能推荐**：基于用户年龄、技能水平、位置偏好自动推荐合适比赛
- **匹配算法**：当双方都表示感兴趣时，自动发送通知并建立联系
- **候补名单**：名额已满时允许用户加入候补队列
- **快速匹配**：「找队友」功能，球员可快速寻找同水平临时队友

**实现位置**：`app/[locale]/(dashboard)/games/` + 新建 `lib/matching/` 算法模块。

---

### 1.2 预订管理

| 属性 | 内容 |
|------|------|
| **模块** | 预订管理 |
| **类型** | 功能增强 + 用户体验 |
| **优先级** | 高 |

**缺失功能**：

1. **预订提醒**
   - 比赛前 24 小时 / 2 小时自动提醒（邮件 + 站内通知）
   - 预订即将到期提醒（周期性预订）
   - 实现：Supabase Edge Functions 或 cron job

2. **取消政策与退款**
   - 明确取消时限（如提前 24 小时可退款）
   - 部分退款（根据取消时间递减）
   - 天气等不可抗力特殊流程

   ```ts
   // lib/booking/policies.ts 示例
   export const CANCELLATION_POLICY = {
     full_refund: 24,    // 24 小时前全额
     partial_refund: 12, // 12 小时前 50%
     no_refund: 0
   };
   ```

3. **周期性预订**
   - 每周固定时段重复预订
   - 批量管理

---

### 1.3 支付与财务

| 属性 | 内容 |
|------|------|
| **模块** | 支付与财务 |
| **类型** | 功能完善 |
| **优先级** | 高 |

**当前状态**：Stripe 已集成，流程不完整。

**必须补充**：

1. **Webhook**
   - 监听 `checkout.session.completed`
   - 监听 `payment_intent.failed`
   - 验证签名防伪造

2. **退款**
   - 自动退款（符合政策）
   - 手动退款（管理员）
   - 退款记录追踪

3. **财务报表**
   - 冰场收入统计
   - 用户消费历史
   - 税务相关记录

**实现位置**：
- `app/api/webhooks/stripe/route.ts`（新建）
- `lib/stripe/refund.ts`（新建）
- `app/[locale]/(dashboard)/admin/revenue/`（管理后台，可选）

---

## 二、用户体验优化

### 2.1 全局加载与错误处理

| 属性 | 内容 |
|------|------|
| **模块** | 全局加载与错误处理 |
| **类型** | 用户体验 |
| **优先级** | 中 |

- **统一骨架屏**：可复用 Skeleton（如 `GameCardSkeleton`、`RinkCardSkeleton`）
- **错误边界**：页面级 `error.tsx`、组件级 `<ErrorBoundary>`，友好提示
- **乐观更新**：React Query 乐观更新，「点赞」「感兴趣」即时反馈

---

### 2.2 表单验证体验

| 属性 | 内容 |
|------|------|
| **模块** | 表单验证体验 |
| **类型** | 用户体验 |
| **优先级** | 中 |

- **实时验证**：输入时即时显示错误
- **字段级错误**：精确定位到字段
- **可访问性**：`aria-invalid`、`aria-describedby`、`role="alert"`

**位置**：Games、Bookings、Profile 等所有表单。

---

### 2.3 移动端优化

| 属性 | 内容 |
|------|------|
| **模块** | 移动端优化 |
| **类型** | 用户体验 + PWA |
| **优先级** | 高 |

- **底部导航**：Play / Community / Bookings / Profile，固定底部
- **手势**：左右滑动切换 Dashboard 标签，下拉刷新
- **离线**：缓存已查看比赛/冰场，离线可浏览并标注「可能过时」
- **推送**：请求通知权限，比赛邀请、预订确认等实时推送

---

## 三、技术架构改进

### 3.1 数据请求层

| 属性 | 内容 |
|------|------|
| **模块** | 数据请求层 |
| **类型** | 技术架构 |
| **优先级** | 中 |

- **全面采用 React Query**：缓存、重新验证、乐观更新、请求去重
- 逐步迁移现有 `useEffect` 数据请求

```ts
// lib/queries/games.ts 示例
export const useGames = (filters) => {
  return useQuery({
    queryKey: ['games', filters],
    queryFn: () => fetchGames(filters),
    staleTime: 5 * 60 * 1000,
  });
};
```

---

### 3.2 性能优化

| 属性 | 内容 |
|------|------|
| **模块** | 性能优化 |
| **类型** | 性能 |
| **优先级** | 中 |

- **图片**：Next.js `<Image>`、WebP、懒加载非首屏
- **代码分割**：动态导入重型组件（如图表），`dynamic(..., { loading: ChartSkeleton })`
- **虚拟列表**：列表 >50 项时考虑 react-window
- **预加载**：`<Link prefetch={true}>` 关键路由

---

### 3.3 SEO 增强

| 属性 | 内容 |
|------|------|
| **模块** | SEO 增强 |
| **类型** | SEO + 增长 |
| **优先级** | 低–中 |

- **动态 Metadata**：`generateMetadata` 为比赛/冰场页生成 title、description、openGraph
- **结构化数据**：Schema.org（SportsEvent、SportsOrganization）
- **Sitemap / robots.txt**：动态生成公开比赛、冰场

---

## 四、安全与数据完整性

### 4.1 权限与角色管理（RBAC）

| 属性 | 内容 |
|------|------|
| **模块** | 权限与角色管理 |
| **类型** | 安全 + 功能增强 |
| **优先级** | 高 |

- **角色**：`player` | `parent` | `club_admin` | `rink_manager` | `super_admin`
- **profiles** 增加 `role`，RLS 按角色限制更新/查看
- **权限矩阵**（摘要）：

| 角色        | 发布比赛 | 管理俱乐部 | 管理冰场 | 查看所有预订 |
|-------------|----------|------------|----------|--------------|
| Player      | ✅       | ❌         | ❌       | 仅自己       |
| Club Admin  | ✅       | ✅         | ❌       | 俱乐部成员   |
| Rink Manager| ❌       | ❌         | ✅       | 所管理冰场   |
| Super Admin | ✅       | ✅         | ✅       | ✅           |

---

### 4.2 输入安全

| 属性 | 内容 |
|------|------|
| **模块** | 输入安全 |
| **类型** | 安全 |
| **优先级** | 高 |

- **服务端验证**：API 层使用 Zod 等校验，不依赖仅客户端验证
- **SQL 注入**：自定义 SQL 使用参数化
- **XSS**：用户输入经 sanitize；`dangerouslySetInnerHTML` 前必须 sanitize
- **CSRF / Webhook**：Stripe webhook 验证签名

---

## 五、运营与增长功能

### 5.1 数据分析与洞察

| 属性 | 内容 |
|------|------|
| **模块** | 数据分析与洞察 |
| **类型** | 功能增强 |
| **优先级** | 低–中 |

- **管理员仪表板**：DAU/MAU、比赛发布与匹配率、冰场预订率、留存
- **行为分析**：热门冰场/时段、活跃时间、流失特征
- **实现**：可复用现有 Recharts / Tremor

---

### 5.2 社区功能

| 属性 | 内容 |
|------|------|
| **模块** | 社区功能 |
| **类型** | 功能增强 |
| **优先级** | 低 |

- **评论与评分**：赛后队友评价、冰场设施评分、信誉体系
- **论坛/讨论区**：技术交流、装备、赛事组织
- **成就系统**：如「参加 10 场比赛」「预订 5 个不同冰场」

---

### 5.3 国际化完善

| 属性 | 内容 |
|------|------|
| **模块** | 国际化完善 |
| **类型** | 国际化 |
| **优先级** | 中 |

- **语言**：优先完善 en、fr（渥太华双语）；zh、hi 不完整可暂停或移除
- **日期**：date-fns + `enCA` / `frCA` 等 locale
- **货币**：CAD 符号与地区习惯

---

## 六、文档与测试、监控

### 6.1 文档与测试

| 属性 | 内容 |
|------|------|
| **模块** | 文档与测试 |
| **类型** | 可维护性 |
| **优先级** | 中 |

- **API 文档**：Swagger/OpenAPI
- **组件文档**：Storybook
- **测试**：单元（关键逻辑）、集成（预订/支付）、E2E（Playwright）

---

### 6.2 监控与运维

| 属性 | 内容 |
|------|------|
| **模块** | 监控与运维 |
| **类型** | 运维 |
| **优先级** | 中 |

- **错误追踪**：Sentry（已集成，需配置 DSN）
- **性能**：Vercel Analytics 或 Google Analytics
- **日志**：结构化日志便于排查

---

## 七、实施优先级建议

> **当前下阶段以 V2 评审为准**，见 [V2_REVIEW_NEXT_PHASE.md](./V2_REVIEW_NEXT_PHASE.md)。下表为长期路线图，与 V2 评审 P0/P1/P2 有重叠，执行时以 V2 为准。

| 优先级 | 项 | 说明 |
|--------|----|------|
| **P0** | Stripe Webhook、DB 预订约束、调试路由保护、RBAC | 支付安全、预订可靠性、权限（V2 评审优先） |
| **P0** | 预订取消政策、移动端底部导航 | 用户信任、主要群体（已完成） |
| **P1** | HydrationBoundary、图片策略、Cron 安全、数据可信度 | V2 评审 P1 |
| **P1** | 比赛智能匹配、预订提醒系统 | 提升匹配效率、体验与留存 |
| **P2** | PWA 推送、数据分析、SEO、性能 | 增长与性能 |
| **P3** | 社区论坛、成就、高级匹配 | 长期社区建设 |

---

## 八、相关文档

- [V2_REVIEW_NEXT_PHASE.md](./V2_REVIEW_NEXT_PHASE.md)：**当前下阶段实施任务**（P0/P1/P2，含 SQL、验收标准）
- [NEXT_PHASE_TASKS.md](./NEXT_PHASE_TASKS.md)：任务与阶段规划
- [PROJECT_REVIEW_REPORT.md](./PROJECT_REVIEW_REPORT.md)：项目综述与审查方向
- [CHANGELOG_IMPROVEMENTS.md](./CHANGELOG_IMPROVEMENTS.md)：已完成的修改记录
